<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Approche Corrigée</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        background: #1a1a1a;
        color: white;
        font-family: Arial, sans-serif;
      }
      #container {
        width: 800px;
        height: 600px;
        border: 2px solid #333;
        margin: 20px 0;
      }
      #info {
        background: #333;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .status {
        padding: 5px 0;
        font-weight: bold;
      }
      .success {
        color: #4caf50;
      }
      .error {
        color: #f44336;
      }
      .loading {
        color: #2196f3;
      }
    </style>
  </head>
  <body>
    <h1>Test Approche Corrigée - Balle 3D</h1>

    <div id="info">
      <div class="status loading" id="status">Initialisation...</div>
      <div id="details"></div>
    </div>

    <div id="container"></div>

    <!-- Nouveau système de chargement -->
    <script src="game/lib/three-fixed.js"></script>

    <script>
      const statusEl = document.getElementById("status");
      const detailsEl = document.getElementById("details");

      function updateStatus(message, type = "loading") {
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
        console.log(message);
      }

      function addDetail(message) {
        const div = document.createElement("div");
        div.textContent = message;
        detailsEl.appendChild(div);
        console.log(message);
      }

      async function initTest() {
        try {
          updateStatus("Chargement des librairies...", "loading");

          // Charger THREE.js et GLTFLoader de manière asynchrone
          await window.loadThreeLibs();

          updateStatus("Vérification des librairies...", "loading");

          if (typeof THREE === "undefined") {
            throw new Error("THREE.js non chargé");
          }
          addDetail("✓ THREE.js chargé (version " + THREE.REVISION + ")");

          if (typeof THREE.GLTFLoader === "undefined") {
            throw new Error("GLTFLoader non disponible");
          }
          addDetail("✓ GLTFLoader disponible");

          updateStatus("Création de la scène...", "loading");

          // Configuration de base
          const container = document.getElementById("container");
          const scene = new THREE.Scene();
          scene.background = new THREE.Color(0x0a0f1a);

          const camera = new THREE.PerspectiveCamera(60, 800 / 600, 0.1, 200);
          camera.position.set(0, 2.2, 6.5);
          camera.lookAt(0, 1, -8);

          const renderer = new THREE.WebGLRenderer({ antialias: true });
          renderer.setSize(800, 600);
          container.appendChild(renderer.domElement);

          // Éclairage
          const hemi = new THREE.HemisphereLight(0xffffff, 0x223355, 0.6);
          scene.add(hemi);
          const dir = new THREE.DirectionalLight(0xffffff, 1.1);
          dir.position.set(3, 5, 4);
          scene.add(dir);

          // Sol
          const fieldGeom = new THREE.PlaneGeometry(20, 40);
          const fieldMat = new THREE.MeshStandardMaterial({
            color: 0x0b5d3c,
            roughness: 0.95,
          });
          const field = new THREE.Mesh(fieldGeom, fieldMat);
          field.rotation.x = -Math.PI / 2;
          scene.add(field);

          addDetail("✓ Scène créée");

          // Balle par défaut
          const ballGeom = new THREE.SphereGeometry(0.22, 32, 32);
          const ballMat = new THREE.MeshStandardMaterial({
            color: 0xffffff,
            roughness: 0.6,
          });
          let ball = new THREE.Mesh(ballGeom, ballMat);
          ball.position.set(0, 0.22, -0.5);
          scene.add(ball);
          addDetail("✓ Balle par défaut ajoutée");

          updateStatus("Chargement de la balle 3D...", "loading");

          // Test du GLTFLoader
          const loader = new THREE.GLTFLoader();
          loader.load(
            "game/assets/models/objects/soccer-ball.glb",
            function (gltf) {
              updateStatus("Balle 3D chargée avec succès!", "success");
              addDetail("✓ Modèle soccer-ball.glb lu correctement");

              // Remplacer la balle
              scene.remove(ball);
              ball = gltf.scene;
              ball.scale.setScalar(0.44);
              ball.position.set(0, 0.22, -0.5);

              ball.traverse(function (node) {
                if (node.isMesh) {
                  addDetail(`✓ Mesh: ${node.name || "sans nom"}`);
                }
              });

              scene.add(ball);
              addDetail("✓ Balle 3D ajoutée à la scène");
            },
            function (progress) {
              const percent = Math.round(
                (progress.loaded / progress.total) * 100
              );
              addDetail(`Progression: ${percent}%`);
            },
            function (error) {
              updateStatus("Erreur lors du chargement!", "error");
              addDetail(`✗ Erreur: ${error.message || error}`);
              console.error("Détails de l'erreur:", error);
            }
          );

          // Animation
          function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
          }

          animate();
          addDetail("✓ Rendu démarré");
        } catch (error) {
          updateStatus(`Erreur: ${error.message}`, "error");
          addDetail(`✗ ${error.message}`);
          console.error("Erreur complète:", error);
        }
      }

      // Démarrer le test
      initTest();
    </script>
  </body>
</html>
